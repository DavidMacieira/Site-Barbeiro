<!DOCTYPE html>
<html lang="pt-PT">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel do Barbeiro — João Angeiras</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600;700&family=Outfit:wght@300;400;500;600&display=swap">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="css/admin.css">
</head>
<body>

<div class="admin-layout">

  <!-- ═══════════════ TOPBAR ═══════════════ -->
  <header class="admin-topbar">
    <div class="topbar-brand">
      <div class="brand-icon"><i class="fas fa-cut"></i></div>
      <div>
        <h1>João Angeiras</h1>
        <span>Painel do Barbeiro</span>
      </div>
    </div>

    <div class="topbar-right">
      <div style="text-align:right;">
        <div class="topbar-time" id="topbarTime">--:--</div>
        <div class="topbar-date" id="topbarDate">--</div>
      </div>
      <button class="btn btn-danger btn-sm" onclick="logout()">
        <i class="fas fa-sign-out-alt"></i> Sair
      </button>
    </div>
  </header>

  <!-- ═══════════════ SIDEBAR ═══════════════ -->
  <aside class="admin-sidebar">
    <div class="sidebar-label">Agenda</div>
    <div class="sidebar-section">
      <button class="sidebar-btn active" onclick="showTab('tabCalendar', this)">
        <i class="fas fa-calendar-week"></i> Calendário
      </button>
      <button class="sidebar-btn" onclick="showTab('tabBookings', this)">
        <i class="fas fa-list"></i> Todas as Reservas
        <span class="badge red" id="sidebarPendingBadge" style="display:none">0</span>
      </button>
    </div>

    <div class="sidebar-label">Gestão</div>
    <div class="sidebar-section">
      <button class="sidebar-btn" onclick="showTab('tabManual', this)">
        <i class="fas fa-plus-circle"></i> Nova Reserva
      </button>
      <button class="sidebar-btn" onclick="showTab('tabBlocked', this)">
        <i class="fas fa-ban"></i> Dias Bloqueados
      </button>
    </div>

    <div class="sidebar-label">Sistema</div>
    <div class="sidebar-section">
      <button class="sidebar-btn" onclick="showTab('tabSettings', this)">
        <i class="fas fa-cog"></i> Configurações
      </button>
    </div>

    <div class="sidebar-divider"></div>
    <div class="sidebar-footer">
      <button class="sidebar-btn" onclick="logout()">
        <i class="fas fa-sign-out-alt"></i> Terminar Sessão
      </button>
    </div>
  </aside>

  <!-- ═══════════════ MAIN ═══════════════ -->
  <main class="admin-main">

    <!-- STAT CARDS -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon gold"><i class="fas fa-calendar-day"></i></div>
        <div class="stat-info">
          <div class="stat-value" id="statToday">0</div>
          <div class="stat-label">Hoje</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon blue"><i class="fas fa-calendar-week"></i></div>
        <div class="stat-info">
          <div class="stat-value" id="statWeek">0</div>
          <div class="stat-label">Esta Semana</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon orange"><i class="fas fa-clock"></i></div>
        <div class="stat-info">
          <div class="stat-value" id="statPending">0</div>
          <div class="stat-label">Pendentes</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon green"><i class="fas fa-euro-sign"></i></div>
        <div class="stat-info">
          <div class="stat-value" id="statRevenue">0€</div>
          <div class="stat-label">Faturação Mês</div>
        </div>
      </div>
    </div>

    <!-- ─── TAB: CALENDÁRIO ─── -->
    <div id="tabCalendar" class="tab-view active">
      <div class="card">
        <div class="cal-toolbar">
          <div class="cal-nav">
            <button onclick="calPrev()" title="Anterior"><i class="fas fa-chevron-left"></i></button>
            <span class="cal-title" id="calTitle">—</span>
            <button onclick="calNext()" title="Próximo"><i class="fas fa-chevron-right"></i></button>
            <button class="cal-today-btn" onclick="calToday()">
              <i class="fas fa-dot-circle"></i> Hoje
            </button>
          </div>
          <div class="view-toggle">
            <button class="active" id="btnWeek" onclick="switchCalView('week')">
              <i class="fas fa-calendar-week"></i> Semana
            </button>
            <button id="btnMonth" onclick="switchCalView('month')">
              <i class="fas fa-calendar"></i> Mês
            </button>
          </div>
        </div>
        <div id="calContainer"></div>
      </div>
    </div>

    <!-- ─── TAB: TODAS AS RESERVAS ─── -->
    <div id="tabBookings" class="tab-view">
      <div class="card">
        <div class="card-header">
          <h3><i class="fas fa-list"></i> Todas as Reservas</h3>
        </div>
        <div class="card-body">
          <div class="filter-bar">
            <div class="form-group">
              <label>Data</label>
              <input type="date" id="filterDate" class="form-control">
            </div>
            <div class="form-group">
              <label>Estado</label>
              <select id="filterStatus" class="form-control">
                <option value="">Todos</option>
                <option value="pending">Pendentes</option>
                <option value="confirmed">Confirmados</option>
                <option value="completed">Concluídos</option>
                <option value="cancelled">Cancelados</option>
              </select>
            </div>
            <button class="btn btn-outline" onclick="loadAllBookings()">
              <i class="fas fa-search"></i> Filtrar
            </button>
            <button class="btn btn-ghost" onclick="clearFilters()">
              <i class="fas fa-times"></i> Limpar
            </button>
          </div>
          <div class="table-wrap">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Data</th>
                  <th>Hora</th>
                  <th>Cliente</th>
                  <th>Telefone</th>
                  <th>Serviço</th>
                  <th>Preço</th>
                  <th>Estado</th>
                  <th>Ações</th>
                </tr>
              </thead>
              <tbody id="bookingsBody">
                <tr><td colspan="8" class="empty-state"><i class="fas fa-spinner fa-spin"></i></td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- ─── TAB: NOVA RESERVA MANUAL ─── -->
    <div id="tabManual" class="tab-view">
      <div class="card" style="max-width:600px;">
        <div class="card-header">
          <h3><i class="fas fa-plus-circle"></i> Nova Reserva pelo Barbeiro</h3>
        </div>
        <div class="card-body" style="display:flex;flex-direction:column;gap:16px;">
          <div class="settings-row">
            <div class="form-group">
              <label>Nome do Cliente *</label>
              <input type="text" id="mName" class="form-control" placeholder="Ex: Pedro Silva">
            </div>
            <div class="form-group">
              <label>Telefone *</label>
              <input type="tel" id="mPhone" class="form-control" placeholder="9XXXXXXXX">
            </div>
          </div>
          <div class="form-group">
            <label>Serviço *</label>
            <select id="mService" class="form-control">
              <option value="">Selecionar serviço...</option>
              <option value="Corte de Cabelo|11|30">Corte de Cabelo — 11€</option>
              <option value="Barba|5|20">Barba — 5€</option>
              <option value="Corte + Barba|15|50">Corte + Barba — 15€</option>
            </select>
          </div>
          <div class="settings-row">
            <div class="form-group">
              <label>Data *</label>
              <input type="date" id="mDate" class="form-control">
            </div>
            <div class="form-group">
              <label>Hora *</label>
              <input type="time" id="mTime" class="form-control" value="10:00" step="1800">
            </div>
          </div>
          <div class="form-group">
            <label>Estado inicial</label>
            <select id="mStatus" class="form-control">
              <option value="confirmed">Confirmado</option>
              <option value="pending">Pendente</option>
            </select>
          </div>
          <div class="form-group">
            <label>Notas (opcional)</label>
            <input type="text" id="mNotes" class="form-control" placeholder="Qualquer observação...">
          </div>
          <div style="display:flex;gap:10px;">
            <button class="btn btn-primary" onclick="saveManualBooking()">
              <i class="fas fa-save"></i> Guardar Reserva
            </button>
            <button class="btn btn-ghost" onclick="clearManualForm()">
              <i class="fas fa-eraser"></i> Limpar
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ─── TAB: DIAS BLOQUEADOS ─── -->
    <div id="tabBlocked" class="tab-view">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;align-items:start;">

        <!-- Formulário bloquear -->
        <div class="card">
          <div class="card-header">
            <h3><i class="fas fa-ban"></i> Bloquear Dia(s)</h3>
          </div>
          <div class="card-body" style="display:flex;flex-direction:column;gap:14px;">
            <div class="form-group">
              <label>Motivo *</label>
              <input type="text" id="blockDesc" class="form-control" placeholder="Ex: Feriado, Férias, Formação...">
            </div>
            <div class="form-group">
              <label>Tipo</label>
              <select id="blockType" class="form-control" onchange="toggleBlockEndDate()">
                <option value="single">Dia único</option>
                <option value="range">Período</option>
              </select>
            </div>
            <div class="form-group">
              <label>Data *</label>
              <input type="date" id="blockStart" class="form-control">
            </div>
            <div class="form-group" id="blockEndGroup" style="display:none;">
              <label>Data Fim *</label>
              <input type="date" id="blockEnd" class="form-control">
            </div>
            <button class="btn btn-danger" onclick="addBlockedDate()" style="align-self:flex-start;">
              <i class="fas fa-ban"></i> Bloquear
            </button>
          </div>
        </div>

        <!-- Lista bloqueados -->
        <div class="card">
          <div class="card-header">
            <h3><i class="fas fa-calendar-times"></i> Dias Bloqueados</h3>
          </div>
          <div class="card-body">
            <div id="blockedList" style="display:flex;flex-direction:column;gap:8px;">
              <p style="color:var(--white-dim);font-size:0.85rem;">Nenhum dia bloqueado.</p>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- ─── TAB: CONFIGURAÇÕES ─── -->
    <div id="tabSettings" class="tab-view">
      <div class="settings-grid">

        <!-- Horários -->
        <div class="card">
          <div class="card-header">
            <h3><i class="fas fa-clock"></i> Horário de Trabalho</h3>
          </div>
          <div class="card-body" style="display:flex;flex-direction:column;gap:16px;">
            <div class="settings-row">
              <div class="form-group">
                <label>Abertura</label>
                <input type="time" id="cfgOpen" class="form-control" value="09:00">
              </div>
              <div class="form-group">
                <label>Fecho</label>
                <input type="time" id="cfgClose" class="form-control" value="19:00">
              </div>
            </div>
            <div class="settings-row">
              <div class="form-group">
                <label>Pausa — Início</label>
                <input type="time" id="cfgBreakStart" class="form-control" value="13:00">
              </div>
              <div class="form-group">
                <label>Pausa — Fim</label>
                <input type="time" id="cfgBreakEnd" class="form-control" value="14:00">
              </div>
            </div>
            <div class="form-group">
              <label>Dias de Trabalho</label>
              <div class="working-days">
                <label class="day-toggle"><input type="checkbox" name="workingDays" value="0"> Dom</label>
                <label class="day-toggle"><input type="checkbox" name="workingDays" value="1"> Seg</label>
                <label class="day-toggle"><input type="checkbox" name="workingDays" value="2" checked> Ter</label>
                <label class="day-toggle"><input type="checkbox" name="workingDays" value="3" checked> Qua</label>
                <label class="day-toggle"><input type="checkbox" name="workingDays" value="4" checked> Qui</label>
                <label class="day-toggle"><input type="checkbox" name="workingDays" value="5" checked> Sex</label>
                <label class="day-toggle"><input type="checkbox" name="workingDays" value="6" checked> Sáb</label>
              </div>
            </div>
            <button class="btn btn-primary" onclick="saveWorkingHours()" style="align-self:flex-start;">
              <i class="fas fa-save"></i> Guardar Horários
            </button>
          </div>
        </div>

        <!-- WhatsApp -->
        <div class="card">
          <div class="card-header">
            <h3><i class="fab fa-whatsapp"></i> WhatsApp</h3>
          </div>
          <div class="card-body" style="display:flex;flex-direction:column;gap:14px;">
            <div class="form-group">
              <label>Número</label>
              <input type="tel" id="cfgWhatsapp" class="form-control" placeholder="+351918749689">
            </div>
            <div class="form-group">
              <label>Mensagem Padrão</label>
              <textarea id="cfgWhatsappMsg" class="form-control" rows="3"
                style="resize:vertical;"
                placeholder="Olá {nome}, a sua reserva está confirmada para {data} às {hora}."></textarea>
            </div>
            <button class="btn btn-primary" onclick="saveWhatsAppSettings()" style="align-self:flex-start;">
              <i class="fas fa-save"></i> Guardar
            </button>
          </div>
        </div>

        <!-- API Status -->
        <div class="card">
          <div class="card-header">
            <h3><i class="fas fa-server"></i> Estado do Sistema</h3>
          </div>
          <div class="card-body" style="display:flex;flex-direction:column;gap:12px;">
            <div id="apiStatusDisplay" style="color:var(--white-dim);font-size:0.85rem;">
              <i class="fas fa-spinner fa-spin"></i> A verificar...
            </div>
            <div style="display:flex;gap:10px;">
              <button class="btn btn-ghost btn-sm" onclick="checkAPIStatus()">
                <i class="fas fa-sync"></i> Testar Ligação
              </button>
            </div>
          </div>
        </div>

      </div>
    </div>

  </main>
</div>

<!-- ═══════════════ MODAL: DETALHES RESERVA ═══════════════ -->
<div class="modal-overlay" id="modalBookingDetail">
  <div class="modal">
    <div class="modal-header">
      <h3><i class="fas fa-calendar-check"></i> Detalhes da Reserva</h3>
      <button class="modal-close" onclick="closeModal('modalBookingDetail')">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body" id="modalBookingDetailBody">
    </div>
    <div class="modal-footer" id="modalBookingDetailFooter">
    </div>
  </div>
</div>

<!-- ═══════════════ TOAST CONTAINER ═══════════════ -->
<div class="toast-container" id="toastContainer"></div>

<!-- Scripts -->
<script src="js/api.js"></script>
<script src="js/admin.js"></script>
</body>
</html>